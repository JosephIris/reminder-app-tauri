<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Quick Add</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }
      html, body {
        background: transparent;
        font-family: 'Segoe UI', system-ui, sans-serif;
        overflow: hidden;
        height: 100%;
      }

      @property --gradient-angle {
        syntax: "<angle>";
        initial-value: 0deg;
        inherits: false;
      }

      @property --glow-opacity {
        syntax: "<number>";
        initial-value: 0.4;
        inherits: false;
      }

      .container {
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 8px;
      }

      .quick-add-content {
        width: 100%;
        display: flex;
        flex-direction: column;
        gap: 6px;
      }

      .hint-text {
        color: #52525b;
        font-size: 11px;
        text-align: center;
        margin: 0;
      }

      .selectors {
        display: flex;
        gap: 8px;
        justify-content: center;
        flex-wrap: wrap;
      }

      .selector-group {
        display: flex;
        gap: 4px;
        align-items: center;
      }

      .selector-label {
        color: #52525b;
        font-size: 10px;
        margin-right: 2px;
      }

      .selector-btn {
        background: #27272a;
        border: 1px solid #3f3f46;
        border-radius: 6px;
        padding: 4px 8px;
        color: #a1a1aa;
        font-size: 11px;
        cursor: pointer;
        transition: all 0.15s ease;
      }

      .selector-btn:hover {
        background: #3f3f46;
        color: #fafafa;
      }

      .selector-btn.selected {
        border-color: currentColor;
      }

      .selector-btn.urgency-now.selected {
        color: #f87171;
        background: rgba(248, 113, 113, 0.15);
      }

      .selector-btn.urgency-today.selected {
        color: #fb923c;
        background: rgba(251, 146, 60, 0.15);
      }

      .selector-btn.urgency-soon.selected {
        color: #facc15;
        background: rgba(250, 204, 21, 0.15);
      }

      .selector-btn.urgency-whenever.selected {
        color: #a1a1aa;
        background: rgba(161, 161, 170, 0.15);
      }

      .selector-btn.list-actual.selected {
        color: #60a5fa;
        background: rgba(96, 165, 250, 0.15);
      }

      .selector-btn.list-backlog.selected {
        color: #a1a1aa;
        background: rgba(161, 161, 170, 0.15);
      }

      .input-wrapper {
        position: relative;
        padding: 2px;
        border-radius: 12px;
        width: 100%;
        background: conic-gradient(
          from var(--gradient-angle),
          #8b5cf6,
          #6366f1,
          #3b82f6,
          #06b6d4,
          #8b5cf6
        );
        animation: gradient-rotate 2s linear infinite, glow-pulse 2s ease-in-out infinite;
        box-shadow:
          0 0 20px rgba(139, 92, 246, var(--glow-opacity)),
          0 0 40px rgba(99, 102, 241, calc(var(--glow-opacity) * 0.5));
      }

      @keyframes gradient-rotate {
        to {
          --gradient-angle: 360deg;
        }
      }

      @keyframes glow-pulse {
        0%, 100% {
          --glow-opacity: 0.3;
        }
        50% {
          --glow-opacity: 0.6;
        }
      }

      .input-box {
        background: #1a1a1a;
        border-radius: 10px;
        overflow: hidden;
      }

      input {
        width: 100%;
        background: transparent;
        border: none;
        padding: 16px 20px;
        color: #fafafa;
        font-size: 18px;
        outline: none;
      }

      input::placeholder {
        color: #71717a;
      }

      input:disabled {
        opacity: 0.6;
      }

      .input-box.saving {
        position: relative;
      }

      .input-box.saving::after {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(139, 92, 246, 0.2), transparent);
        animation: loading-sweep 1s ease-in-out infinite;
      }

      @keyframes loading-sweep {
        0% { transform: translateX(-100%); }
        100% { transform: translateX(100%); }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="quick-add-content">
        <div class="input-wrapper">
          <div class="input-box">
            <input
              type="text"
              id="input"
              placeholder="What do you need to remember?"
              autofocus
            />
          </div>
        </div>
        <div class="selectors">
          <div class="selector-group" id="urgency-group">
            <button class="selector-btn urgency-now" data-value="now">Now</button>
            <button class="selector-btn urgency-today selected" data-value="today">Today</button>
            <button class="selector-btn urgency-soon" data-value="soon">Soon</button>
            <button class="selector-btn urgency-whenever" data-value="whenever">Whenever</button>
          </div>
          <div class="selector-group" id="list-group">
            <button class="selector-btn list-actual selected" data-value="actual">Actual</button>
            <button class="selector-btn list-backlog" data-value="backlog">Backlog</button>
          </div>
        </div>
        <p class="hint-text">Press Enter to add</p>
      </div>
    </div>

    <script type="module">
      // Wait for Tauri to be ready - this is critical on Windows
      async function waitForTauri() {
        return new Promise((resolve) => {
          if (window.__TAURI__) {
            resolve();
          } else {
            // Poll until Tauri is available
            const interval = setInterval(() => {
              if (window.__TAURI__) {
                clearInterval(interval);
                resolve();
              }
            }, 10);
          }
        });
      }

      async function init() {
        await waitForTauri();

        const { invoke } = window.__TAURI__.core;
        const { getCurrentWindow } = window.__TAURI__.window;

        const input = document.getElementById('input');
        const win = getCurrentWindow();
        let isBusy = false;

        const inputBox = document.querySelector('.input-box');
        const urgencyGroup = document.getElementById('urgency-group');
        const listGroup = document.getElementById('list-group');

        // State
        let selectedUrgency = 'today';
        let selectedListType = 'actual';

        console.log('Quick add initialized, window:', win.label);

        // Clear any previous input and reset state
        input.value = '';
        input.disabled = false;
        inputBox.classList.remove('saving');

        // Setup selector button handlers
        function setupSelectors() {
          // Urgency buttons
          urgencyGroup.querySelectorAll('.selector-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
              e.preventDefault();
              e.stopPropagation();
              selectedUrgency = btn.dataset.value;
              urgencyGroup.querySelectorAll('.selector-btn').forEach(b => b.classList.remove('selected'));
              btn.classList.add('selected');
              input.focus();
            });
          });

          // List type buttons
          listGroup.querySelectorAll('.selector-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
              e.preventDefault();
              e.stopPropagation();
              selectedListType = btn.dataset.value;
              listGroup.querySelectorAll('.selector-btn').forEach(b => b.classList.remove('selected'));
              btn.classList.add('selected');
              input.focus();
            });
          });
        }

        setupSelectors();

        // Aggressive focus strategy for Windows
        async function focusInput() {
          // First ensure window has focus
          try {
            await win.setFocus();
          } catch (e) {
            console.log('setFocus error:', e);
          }
          // Then focus the input
          input.focus();
        }

        // Focus immediately and keep trying
        focusInput();
        setTimeout(focusInput, 50);
        setTimeout(focusInput, 100);
        setTimeout(focusInput, 200);
        setTimeout(focusInput, 500);

        // Close window using destroy() to force close without events
        async function closeWindow() {
          if (isBusy) return;
          isBusy = true;
          console.log('Destroying window...');
          try {
            await win.destroy();
          } catch (e) {
            console.error('Failed to destroy window:', e);
            // Fallback to close
            try {
              await win.close();
            } catch (e2) {
              console.error('Failed to close window:', e2);
            }
          }
        }

        // Submit reminder
        async function handleSubmit() {
          const text = input.value.trim();
          console.log('Submit:', text, 'urgency:', selectedUrgency, 'list:', selectedListType);

          if (!text || isBusy) return;

          isBusy = true;
          input.disabled = true;
          inputBox.classList.add('saving');

          const message = text.charAt(0).toUpperCase() + text.slice(1);

          try {
            await invoke("add_reminder", {
              message: message,
              urgency: selectedUrgency,
              listType: selectedListType
            });
            console.log('Reminder added successfully');
          } catch (e) {
            console.error("Failed to add reminder:", e);
          }

          // Always close after submit attempt
          console.log('Closing after submit...');
          try {
            await win.destroy();
          } catch (e) {
            console.error('Failed to destroy after submit:', e);
          }
        }

        // Keyboard event handler
        function handleKeyDown(e) {
          console.log('Key pressed:', e.key);

          if (e.key === 'Escape') {
            e.preventDefault();
            e.stopPropagation();
            closeWindow();
          } else if (e.key === 'Enter') {
            e.preventDefault();
            e.stopPropagation();
            handleSubmit();
          }
        }

        // Blur handler - close if not busy
        function handleBlur() {
          console.log('Window blur');
          if (!isBusy) {
            closeWindow();
          }
        }

        // Attach event listeners
        document.addEventListener('keydown', handleKeyDown);
        window.addEventListener('blur', handleBlur);
      }

      // Start initialization
      init().catch(e => console.error('Init failed:', e));
    </script>
  </body>
</html>
